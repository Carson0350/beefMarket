<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>5.2</storyId>
    <title>Inquiry Email Notifications to Ranch Owners</title>
    <status>drafted</status>
    <generatedAt>2025-11-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/5-2-inquiry-email-notifications-to-ranch-owners.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>ranch owner</asA>
    <iWant>to receive an email notification immediately when a breeder submits an inquiry about one of my bulls</iWant>
    <soThat>I can respond quickly to potential customers and not miss sales opportunities</soThat>
    <tasks>
**Task 1: Create API Route for Inquiries** (AC: All)
- Create `/app/api/inquiries/route.ts`
- Implement POST handler
- Validate request body with Zod schema
- Check bull exists and is published
- Create inquiry record in database
- Trigger email notification (async)
- Return 201 response with inquiry data
- Handle errors and return appropriate status codes

**Task 2: Create Email Template** (AC: 5.2.2, 5.2.3, 5.2.6)
- Create `emails/inquiry-notification.tsx` using React Email
- Design email layout (header, body, footer)
- Add bull photo (thumbnail, responsive)
- Format breeder contact information
- Display full inquiry message
- Add timestamp
- Style for mobile responsiveness
- Test email rendering in multiple clients

**Task 3: Implement Email Sending Function** (AC: 5.2.1, 5.2.4, 5.2.5)
- Add `sendInquiryNotification()` to `lib/email.ts`
- Fetch ranch owner email from database
- Fetch bull details for email content
- Construct email with React Email template
- Set subject line with bull and breeder names
- Set reply-to header to breeder email
- Add dashboard link with full URL
- Send via Resend API
- Return delivery confirmation

**Task 4: Implement Retry Logic** (AC: 5.2.7)
- Create retry wrapper function
- Implement exponential backoff (1s, 5s, 15s)
- Log each attempt with timestamp
- Log failure reasons
- Return success/failure status
- Handle Resend API errors gracefully

**Task 5: Error Handling and Logging** (AC: 5.2.8)
- Wrap email sending in try-catch
- Log email delivery failures
- Ensure inquiry saves even if email fails
- Store email delivery status (optional)
- Add monitoring for email failure rate

**Task 6: Integration with Inquiry Creation** (AC: 5.2.1)
- Call `sendInquiryNotification()` after inquiry creation
- Make email sending asynchronous (non-blocking)
- Don't wait for email completion before returning response
- Handle email errors without affecting inquiry creation

**Task 7: Testing**
- Test inquiry creation with valid data
- Test email is sent with correct content
- Test email subject line format
- Test reply-to header is set correctly
- Test dashboard link is correct
- Test email rendering on mobile
- Test retry logic with simulated failures
- Test inquiry saves when email fails
- Test rate limiting (10 inquiries/hour per IP)
- Integration test: end-to-end inquiry submission
    </tasks>
  </story>

  <acceptanceCriteria>
### AC-5.2.1: Immediate Email Delivery
**Given** a breeder submits an inquiry about my bull  
**When** the inquiry is successfully saved to the database  
**Then** I should receive an email notification within 5 seconds
**And** email delivery is asynchronous (doesn't block the inquiry submission response)

### AC-5.2.2: Email Subject Line
**Given** I receive an inquiry notification email  
**When** I view the email in my inbox  
**Then** the subject line should be: "New Inquiry: [Bull Name] from [Breeder Name]"
**And** the subject clearly identifies which bull and who inquired

### AC-5.2.3: Email Body Content
**Given** I receive an inquiry notification email  
**When** I open the email  
**Then** the email body should include:
- Bull name and photo (thumbnail)
- Breeder name
- Breeder email address
- Breeder phone number (if provided)
- Full inquiry message
- Timestamp of inquiry
**And** all information is clearly formatted and readable

### AC-5.2.4: Dashboard Link
**Given** I receive an inquiry notification email  
**When** I review the email content  
**Then** I should see a prominent call-to-action button/link: "View in Dashboard"
**And** clicking the link takes me directly to `/dashboard/inquiries`

### AC-5.2.5: Reply-To Header
**Given** I receive an inquiry notification email  
**When** I click "Reply" in my email client  
**Then** the reply should be addressed to the breeder's email
**And** I can respond directly without copying the email address

### AC-5.2.6: Mobile-Responsive Email
**Given** I receive an inquiry notification email  
**When** I view it on a mobile device  
**Then** the email should be:
- Readable without horizontal scrolling
- Images sized appropriately
- Buttons/links touch-friendly
- Professional appearance maintained

### AC-5.2.7: Email Delivery Retry Logic
**Given** the email service fails to deliver an email  
**When** the initial send attempt fails  
**Then** the system should:
- Retry up to 3 times with exponential backoff (1s, 5s, 15s)
- Log each attempt and failure reason
- Continue retrying until success or max attempts reached
**And** inquiry is still saved even if all email attempts fail

### AC-5.2.8: Inquiry Saved on Email Failure
**Given** all email delivery attempts fail  
**When** the inquiry submission completes  
**Then** the inquiry should still be saved to the database
**And** the breeder receives a success confirmation
**And** the failed email delivery is logged for manual review
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification - Inquiry & Communication</title>
        <section>APIs and Interfaces > POST /api/inquiries</section>
        <snippet>Public endpoint for creating inquiries. Validates bullId, breederName (2-100 chars), breederEmail, optional breederPhone, message (10-2000 chars). Returns 201 with inquiry object. Rate limited to 10 requests/hour per IP. Triggers async email notification.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>Workflows > Workflow 2: Email Notification to Ranch Owner</section>
        <snippet>Email sent via Resend API with subject "New Inquiry: [Bull Name] from [Breeder Name]". Body includes bull details, breeder contact info, inquiry message, dashboard link. Reply-to header set to breeder email. Retry logic: 3 attempts with exponential backoff if delivery fails.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>Data Models > Inquiry Model</section>
        <snippet>Inquiry model includes: bullId, ranchId, breederName, breederEmail, breederPhone (optional), message, status (UNREAD/RESPONDED/ARCHIVED), internalNotes, respondedAt, timestamps. Relations to Bull and Ranch with cascade delete. Indexed on ranchId, bullId, status, createdAt.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-5.md</path>
        <title>Epic 5 Technical Specification</title>
        <section>NFR > Reliability > Email Delivery Reliability</section>
        <snippet>Retry logic: 3 attempts with exponential backoff (1s, 5s, 15s). All email failures logged for manual review. If email fails after retries, inquiry still saved (ranch owner can view in dashboard). Graceful degradation ensures inquiry creation succeeds even if email service is down.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-8.2: Inquiry Notifications</section>
        <snippet>Ranch owners receive immediate email notifications when breeders submit inquiries. Email includes bull details, breeder contact information, and direct link to inquiry dashboard. Reply-to header enables direct email response to breeder.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Technical Architecture</title>
        <section>AD-6: Email Service - Resend</section>
        <snippet>Resend used for transactional emails with React Email for templates (JSX-based). Free tier provides 3,000 emails/month. Modern API with excellent DX and good deliverability. Simple integration with Next.js.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>lib/email.ts</path>
        <kind>service</kind>
        <symbol>sendVerificationEmail, sendInventoryChangeEmail, sendPriceChangeEmail</symbol>
        <lines>1-487</lines>
        <reason>Existing email service module with Resend integration. Shows pattern for email functions: retry logic not yet implemented, uses HTML templates, handles errors with try-catch. New sendInquiryNotification() function will follow this pattern.</reason>
      </artifact>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>Inquiry model</symbol>
        <lines>126-159</lines>
        <reason>Inquiry model already defined with all required fields: bullId, ranchId, breederName, breederEmail, breederPhone, message, status (InquiryStatus enum), internalNotes, respondedAt, timestamps. Relations to Bull and Ranch with proper indexes.</reason>
      </artifact>
      <artifact>
        <path>app/api/bulls/[id]/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET, PATCH, DELETE handlers</symbol>
        <lines>N/A</lines>
        <reason>Example API route pattern for reference. Shows Next.js App Router API route structure, authentication checks, Prisma queries, error handling, and response formatting.</reason>
      </artifact>
      <artifact>
        <path>app/api/favorites/route.ts</path>
        <kind>api-route</kind>
        <symbol>GET, POST handlers</symbol>
        <lines>N/A</lines>
        <reason>Example of public POST endpoint pattern. Shows request validation, database operations, error handling, and proper HTTP status codes.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="resend" version="^6.4.2">Email API client for sending transactional emails</package>
        <package name="@prisma/client" version="^6.19.0">Database ORM for inquiry CRUD operations</package>
        <package name="next" version="^14.2.0">Framework for API routes</package>
        <package name="next-auth" version="^5.0.0-beta.30">Authentication (not required for this story - inquiry submission is public)</package>
        <package name="zod" version="TBD">Input validation schemas (may need to install if not present)</package>
        <package name="@react-email/components" version="TBD">React Email components for email templates (needs installation)</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>API Route must be public (no authentication required) to allow breeders to submit inquiries without account</constraint>
    <constraint>Rate limiting: 10 requests per hour per IP address to prevent spam</constraint>
    <constraint>Email sending must be asynchronous (non-blocking) - API should return 201 immediately after saving inquiry, not wait for email delivery</constraint>
    <constraint>Inquiry must be saved to database even if email delivery fails (graceful degradation)</constraint>
    <constraint>Email retry logic: Maximum 3 attempts with exponential backoff (1s, 5s, 15s)</constraint>
    <constraint>All email delivery failures must be logged with error details for manual review</constraint>
    <constraint>Email template must be mobile-responsive (readable without horizontal scrolling)</constraint>
    <constraint>Reply-to header must be set to breeder's email to enable direct response</constraint>
    <constraint>Dashboard link in email must use full URL (process.env.NEXTAUTH_URL or NEXT_PUBLIC_APP_URL)</constraint>
    <constraint>Follow existing email service patterns in lib/email.ts (Resend client, HTML templates, error handling)</constraint>
    <constraint>Use Zod for request validation (consistent with other API routes)</constraint>
    <constraint>Validation rules: breederName (2-100 chars), breederEmail (valid email), message (10-2000 chars), breederPhone (optional)</constraint>
    <constraint>Bull must exist and have status='PUBLISHED' before allowing inquiry submission</constraint>
    <constraint>Email subject format: "New Inquiry: [Bull Name] from [Breeder Name]"</constraint>
    <constraint>Email delivery target: within 5 seconds of inquiry submission</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>POST /api/inquiries</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/inquiries
Request Body: { bullId: string, breederName: string, breederEmail: string, breederPhone?: string, message: string }
Response 201: { inquiry: { id, bullId, ranchId, breederName, breederEmail, breederPhone, message, status: 'UNREAD', createdAt } }
Response 400: { error: string, details?: ZodError }
Response 404: { error: 'Bull not found' }
Response 429: { error: 'Rate limit exceeded' }
Response 500: { error: 'Internal server error' }</signature>
      <path>app/api/inquiries/route.ts</path>
    </interface>
    <interface>
      <name>sendInquiryNotification</name>
      <kind>Email service function</kind>
      <signature>async function sendInquiryNotification(params: {
  inquiry: { id, breederName, breederEmail, breederPhone, message, createdAt },
  bull: { name, heroImage, ranchId },
  ranchOwnerEmail: string,
  ranchOwnerName: string,
  ranchName: string
}): Promise&lt;{ success: boolean; error?: string }&gt;</signature>
      <path>lib/email.ts</path>
    </interface>
    <interface>
      <name>Resend API - emails.send</name>
      <kind>External API</kind>
      <signature>await resend.emails.send({
  from: string,
  to: string,
  replyTo: string,
  subject: string,
  html?: string,
  react?: ReactElement
})</signature>
      <path>node_modules/resend</path>
    </interface>
    <interface>
      <name>Prisma - Inquiry.create</name>
      <kind>Database operation</kind>
      <signature>await prisma.inquiry.create({
  data: {
    bullId: string,
    ranchId: string,
    breederName: string,
    breederEmail: string,
    breederPhone?: string,
    message: string,
    status: 'UNREAD'
  }
})</signature>
      <path>prisma/schema.prisma</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
Testing approach for this story should include unit tests for validation logic, integration tests for the API endpoint and email sending flow, and manual testing for email rendering. Follow existing patterns in the codebase if tests are present. Key areas to test:

1. **Unit Tests**: Zod schema validation (valid/invalid inputs), retry logic with exponential backoff, email template rendering
2. **Integration Tests**: Full inquiry submission flow (API → Database → Email), error handling (invalid bull, validation failures), graceful degradation (email failure doesn't prevent inquiry save)
3. **API Tests**: Authentication (public endpoint), rate limiting (10/hour per IP), response codes (201, 400, 404, 429, 500)
4. **Manual Tests**: Email rendering in multiple clients (Gmail, Outlook, mobile), reply-to functionality, dashboard link navigation

No existing test framework detected in project structure. Tests should be added if time permits, otherwise rely on manual testing and integration verification.
    </standards>
    <locations>
      <location>__tests__/api/inquiries.test.ts (if tests are added)</location>
      <location>__tests__/lib/email.test.ts (if tests are added)</location>
      <location>Manual testing via Postman or curl for API endpoints</location>
      <location>Manual email testing via Resend dashboard or test email accounts</location>
    </locations>
    <ideas>
      <test id="AC-5.2.1">
        <criteria>AC-5.2.1: Immediate Email Delivery</criteria>
        <approach>Integration test: Submit inquiry via API, verify email sent within 5 seconds (mock or use test email). Verify API returns 201 before email completes (async behavior).</approach>
      </test>
      <test id="AC-5.2.2">
        <criteria>AC-5.2.2: Email Subject Line</criteria>
        <approach>Unit test: Verify subject format "New Inquiry: [Bull Name] from [Breeder Name]" with various bull/breeder names. Integration test: Check actual email subject in test inbox.</approach>
      </test>
      <test id="AC-5.2.3">
        <criteria>AC-5.2.3: Email Body Content</criteria>
        <approach>Manual test: Send test inquiry, verify email includes bull name, photo, breeder name/email/phone, message, timestamp. Check formatting and readability.</approach>
      </test>
      <test id="AC-5.2.4">
        <criteria>AC-5.2.4: Dashboard Link</criteria>
        <approach>Manual test: Click "View in Dashboard" link in email, verify it navigates to /dashboard/inquiries with correct URL (production or staging).</approach>
      </test>
      <test id="AC-5.2.5">
        <criteria>AC-5.2.5: Reply-To Header</criteria>
        <approach>Manual test: Open inquiry email, click Reply, verify recipient is breeder's email (not system email). Test in Gmail and Outlook.</approach>
      </test>
      <test id="AC-5.2.6">
        <criteria>AC-5.2.6: Mobile-Responsive Email</criteria>
        <approach>Manual test: Forward email to mobile device, verify readable without horizontal scrolling, images sized appropriately, buttons touch-friendly.</approach>
      </test>
      <test id="AC-5.2.7">
        <criteria>AC-5.2.7: Email Delivery Retry Logic</criteria>
        <approach>Unit test: Mock Resend API to fail, verify retry attempts (3 times) with correct delays (1s, 5s, 15s). Verify logging of each attempt and failure reason.</approach>
      </test>
      <test id="AC-5.2.8">
        <criteria>AC-5.2.8: Inquiry Saved on Email Failure</criteria>
        <approach>Integration test: Mock Resend API to fail all attempts, submit inquiry, verify inquiry saved to database with status UNREAD. Verify API returns 201 success. Check logs for email failure.</approach>
      </test>
      <test id="validation">
        <criteria>Request Validation</criteria>
        <approach>API tests: Submit inquiries with invalid data (missing fields, invalid email, message too short/long, invalid bullId). Verify 400 responses with clear error messages.</approach>
      </test>
      <test id="rate-limiting">
        <criteria>Rate Limiting</criteria>
        <approach>API test: Submit 11 inquiries from same IP within 1 hour, verify 11th request returns 429. Wait 1 hour, verify rate limit resets.</approach>
      </test>
    </ideas>
  </tests>
</story-context>
